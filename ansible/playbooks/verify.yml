- hosts: k3s_server
  become: true
  tasks:
    - name: Wait for nodes to be Ready
      ansible.builtin.command: kubectl get nodes
      register: nodes_out
      changed_when: false
      retries: 30
      delay: 5
      until: >
        (nodes_out.stdout_lines | select('search', ' Ready ') | list | length)
        >= (groups['k3s_server'] | length + groups['k3s_agents'] | length)

    - name: Show nodes
      ansible.builtin.command: kubectl get nodes -o wide
      register: nodes_wide
      changed_when: false

    - name: Show system pods
      ansible.builtin.command: kubectl get pods -A -o wide
      register: pods_wide
      changed_when: false

    - name: Print nodes and pods
      ansible.builtin.debug:
        msg:
          - "{{ nodes_wide.stdout }}"
          - "{{ pods_wide.stdout }}"
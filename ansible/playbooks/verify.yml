- hosts: k3s_server
  become: true
  tasks:
    - name: Make SELinux permissive on all nodes (lab)
      hosts: all
      become: true
      tasks:
        - name: Check SELinux status
          ansible.builtin.command: getenforce
          register: se_status
          changed_when: false

        - name: Set SELinux to permissive (runtime)
          ansible.builtin.command: setenforce 0
          when: se_status.stdout == "Enforcing"

        - name: Persist SELinux permissive in config
          ansible.builtin.replace:
            path: /etc/selinux/config
            regexp: '^SELINUX=.*$'
            replace: 'SELINUX=permissive'
            backup: true

    - name: Restart k3s services
      hosts: k3s_server
      become: true
      tasks:
        - name: Restart k3s server
          ansible.builtin.service:
            name: k3s
            state: restarted

    - name: Restart k3s-agent services
      hosts: k3s_agents
      become: true
      tasks:
        - name: Restart k3s agent
          ansible.builtin.service:
            name: k3s-agent
            state: restarted

    - name: Wait for nodes to be Ready
      ansible.builtin.command: kubectl get nodes
      register: nodes_out
      changed_when: false
      retries: 30
      delay: 5
      until: >
        (nodes_out.stdout_lines | select('search', ' Ready ') | list | length)
        >= (groups['k3s_server'] | length + groups['k3s_agents'] | length)

    - name: Show nodes
      ansible.builtin.command: kubectl get nodes -o wide
      register: nodes_wide
      changed_when: false

    - name: Show system pods
      ansible.builtin.command: kubectl get pods -A -o wide
      register: pods_wide
      changed_when: false

    - name: Print nodes and pods
      ansible.builtin.debug:
        msg:
          - "{{ nodes_wide.stdout }}"
          - "{{ pods_wide.stdout }}"

    - name: Get kube-system pods
      ansible.builtin.command: kubectl get pods -n kube-system --no-headers
      register: ks_pods
      changed_when: false

    - name: Fail if kube-system has unhealthy pods
      ansible.builtin.assert:
        that:
          - ks_pods.stdout_lines | select('search', 'CrashLoopBackOff|CreateContainerError|ImagePullBackOff|Error') | list | length == 0
        fail_msg: "kube-system has unhealthy pods. Run: kubectl get pods -n kube-system -o wide"